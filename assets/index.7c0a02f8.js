import{p as L,q as be}from"./vendor-lark.9e248cc2.js";import{j as me,$ as e}from"./vendor-jquery.88f4ff12.js";import{i as c,B as Be}from"./vendor-i18n.7cd67a60.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))u(o);new MutationObserver(o=>{for(const h of o)if(h.type==="childList")for(const y of h.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&u(y)}).observe(document,{childList:!0,subtree:!0});function r(o){const h={};return o.integrity&&(h.integrity=o.integrity),o.referrerpolicy&&(h.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?h.credentials="include":o.crossorigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function u(o){if(o.ep)return;o.ep=!0;const h=r(o);fetch(o.href,h)}})();const ye="\u5C0F\u7EA2\u4E66\u535A\u4E3B\u7B14\u8BB0\u83B7\u53D6",Fe="\u4E00\u952E\u5F0F\u83B7\u53D6\u5C0F\u7EA2\u4E66\u535A\u4E3B\u7684\u7B14\u8BB0\u6570\u636E,\u5305\u62EC\u539F\u56FE/\u89C6\u9891/\u89C6\u9891\u6587\u672C",we={user:"\u7528\u6237",userName:"\u7528\u6237\u540D",userId:"\u7528\u6237ID",vipLevel:"VIP\u7B49\u7EA7",remainDownloads:"\u53EF\u4E0B\u8F7D\u6B21\u6570",boundTables:"\u5DF2\u7ED1\u5B9A\u8868\u683C",expireTime:"\u5230\u671F\u65F6\u95F4",normalUser:"\u666E\u901A\u7528\u6237",membershipExpired:"\u4F1A\u5458\u5DF2\u8FC7\u671F"},ve={title:"\u5DF2\u7ED1\u5B9A\u8868\u683C\u5217\u8868",empty:"\u6682\u65E0\u5DF2\u7ED1\u5B9A\u7684\u8868\u683C",tableName:"\u8868\u683C\u540D\u79F0",tableId:"\u8868\u683CID",xhsBinding:"\u5C0F\u7EA2\u4E66\u53F7\u7ED1\u5B9A",remark:"\u5907\u6CE8",bound:"\u5DF2\u7ED1\u5B9A",notBound:"\u672A\u7ED1\u5B9A",openTable:"\u6253\u5F00\u8868\u683C"},xe={title:"\u6570\u636E\u8868\u7BA1\u7406",noTables:"\u6682\u65E0\u6570\u636E\u8868",tableId:"Table ID",xhsId:"\u5C0F\u7EA2\u4E66\u7ED1\u5B9AID",notBound:"\u672A\u7ED1\u5B9A",remark:"\u5907\u6CE8",bound:"\u5DF2\u7ED1\u5B9A",unbound:"\u672A\u7ED1\u5B9A"},Te={existingTables:"\u73B0\u6709\u8868\u683C",newTable:"\u65B0\u5EFA\u8868\u683C"},Ee={tableName:"\u8868\u683C\u540D\u79F0",tableDesc:"\u8868\u683C\u63CF\u8FF0(\u53EF\u9009)",previewTitle:"\u5C06\u81EA\u52A8\u521B\u5EFA\u4EE5\u4E0B\u5B57\u6BB5"},ke={selectTable:"\u9009\u62E9\u8868\u683C",pleaseSelect:"\u8BF7\u9009\u62E9\u8868\u683C",tableName:"\u8868\u683C\u540D\u79F0",tableId:"Table ID",xhsId:"\u5C0F\u7EA2\u4E66ID",remark:"\u5907\u6CE8",bound:"\u5DF2\u8BBE\u7F6E",notBound:"\u672A\u8BBE\u7F6E\u81EA\u52A8\u63A8\u9001"},Ie={bindTitle:"\u63A8\u9001\u8BBE\u7F6E",editTitle:"\u4FEE\u6539\u81EA\u52A8\u63A8\u9001\u8BBE\u7F6E",tableName:"\u8868\u683C\u540D\u79F0",personalBaseToken:"Personal Base Token",personalBaseTokenHint:"\u6BCF\u4E2A\u591A\u7EF4\u8868\u683C\u4E00\u4E2A\u552F\u4E00\u6807\u8BC6",xhsUrl:"\u5C0F\u7EA2\u4E66\u7ED1\u5B9A(\u7ED1\u5B9A\u540E\u652F\u6301\u624B\u673A\u5BA2\u6237\u7AEF\u63A8\u9001)",xhsUrlHint:"\u652F\u6301 xiaohongshu.com \u6216 xhslink.com \u94FE\u63A5\uFF0C\u6216\u76F4\u63A5\u8F93\u516524\u4F4D\u5C0F\u7EA2\u4E66ID",remark:"\u5907\u6CE8\uFF08\u53EF\u9009\uFF09",fieldSelection:"\u5B57\u6BB5\u9009\u62E9",fieldSelectionHint:"\u9009\u62E9\u9700\u8981\u91C7\u96C6\u7684\u5B57\u6BB5\uFF0C\u672A\u9009\u62E9\u7684\u5B57\u6BB5\u5C06\u4E0D\u4F1A\u88AB\u586B\u5145\u6570\u636E",selectAll:"\u5168\u9009",deselectAll:"\u6E05\u7A7A",extractedInfo:"\u63D0\u53D6\u4FE1\u606F",appToken:"App Token",tableId:"Table ID",xhsId:"XHS ID"},Ce={refresh:"\u5237\u65B0",activate:"\u5F00\u901A",renew:"\u7EED\u8D39",bind:"\u63A8\u9001\u8BBE\u7F6E",edit:"\u4FEE\u6539\u8BBE\u7F6E",unbind:"\u89E3\u9664\u8BBE\u7F6E",save:"\u4FDD\u5B58",cancel:"\u53D6\u6D88",close:"\u5173\u95ED",chatGroup:"\u4EA4\u6D41\u7FA4",support:"\u6280\u672F\u652F\u6301",createTable:"\u521B\u5EFA\u8868\u683C",startProcessing:"\u5F00\u59CB\u83B7\u53D6\u535A\u4E3B\u7B14\u8BB0",help:"\u5E2E\u52A9"},De={saving:"\u6B63\u5728\u4FDD\u5B58...",saveSuccess:"\u4FDD\u5B58\u6210\u529F",saveFailed:"\u4FDD\u5B58\u5931\u8D25",fieldSelectionSaved:"\u9ED8\u8BA4\u5B57\u6BB5\u9009\u62E9\u5DF2\u4FDD\u5B58",unbinding:"\u6B63\u5728\u89E3\u9664\u7ED1\u5B9A...",unbindSuccess:"\u89E3\u9664\u7ED1\u5B9A\u6210\u529F",unbindFailed:"\u89E3\u9664\u7ED1\u5B9A\u5931\u8D25",confirmUnbind:"\u89E3\u9664\u7ED1\u5B9A\u540E\u5C06\u4E0D\u80FD\u6536\u5230\u63A8\u9001\u6D88\u606F\uFF0C\u786E\u8BA4\u8981\u89E3\u9664\u8BE5\u8868\u683C\u7684\u7ED1\u5B9A\u5417\uFF1F",pleaseLoginFirst:"\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743",cannotGetBaseInfo:"\u65E0\u6CD5\u83B7\u53D6Base\u4FE1\u606F",openModalFailed:"\u6253\u5F00\u7ED1\u5B9A\u7A97\u53E3\u5931\u8D25",invalidUrl:"\u65E0\u6548\u7684\u94FE\u63A5",pleaseInputPersonalBaseToken:"\u8BF7\u8F93\u5165Personal Base Token",pleaseInputXhsUrl:"\u8BF7\u8F93\u5165\u5C0F\u7EA2\u4E66\u4E3B\u9875\u94FE\u63A5",extractXhsIdFailed:"\u63D0\u53D6\u5C0F\u7EA2\u4E66ID\u5931\u8D25",refreshingUserInfo:"\u6B63\u5728\u5237\u65B0\u7528\u6237\u4FE1\u606F...",userInfoRefreshSuccess:"\u7528\u6237\u4FE1\u606F\u5237\u65B0\u6210\u529F",refreshFailed:"\u5237\u65B0\u5931\u8D25",authorizationExpired:"\u6388\u6743\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55",unknownError:"\u672A\u77E5\u9519\u8BEF",pleaseSelectTableFirst:"\u8BF7\u5148\u9009\u62E9\u4E00\u4E2A\u8868\u683C",loadTableListFailed:"\u52A0\u8F7D\u8868\u683C\u5217\u8868\u5931\u8D25",updating:"\u6B63\u5728\u66F4\u65B0...",updateSuccess:"\u66F4\u65B0\u6210\u529F",updateFailed:"\u66F4\u65B0\u5931\u8D25"},Ae={failed:"\u6388\u6743\u5931\u8D25",failedMessage:"\u65E0\u6CD5\u9A8C\u8BC1\u60A8\u7684\u6388\u6743\u4FE1\u606F\uFF0C\u8BF7\u5C06\u4EE5\u4E0B\u4FE1\u606F\u63D0\u4F9B\u7ED9\u7BA1\u7406\u5458",tenantKey:"\u79DF\u6237\u5BC6\u94A5"},$e={verifying:"\u6B63\u5728\u9A8C\u8BC1\u6388\u6743..."},Se={hint:"\u5C06\u81EA\u52A8\u83B7\u53D6\u535A\u4E3B\u7684\u6240\u6709\u7B14\u8BB0\u5E76\u6DFB\u52A0\u5230\u8868\u683C"},Le={title:"\u514D\u8D23\u58F0\u660E",content:`1. \u672C\u63D2\u4EF6\u4EC5\u7528\u4E8E\u4E2A\u4EBA\u5B66\u4E60\u548C\u7814\u7A76\u76EE\u7684,\u4E0D\u5F97\u7528\u4E8E\u4EFB\u4F55\u5546\u4E1A\u7528\u9014\u3002
2. \u7528\u6237\u4F7F\u7528\u672C\u63D2\u4EF6\u91C7\u96C6\u7684\u6570\u636E,\u5E94\u9075\u5B88\u5C0F\u7EA2\u4E66\u5E73\u53F0\u7684\u76F8\u5173\u89C4\u5B9A\u548C\u7528\u6237\u534F\u8BAE\u3002
3. \u672C\u63D2\u4EF6\u4E0D\u5BF9\u91C7\u96C6\u5185\u5BB9\u7684\u51C6\u786E\u6027\u3001\u5B8C\u6574\u6027\u548C\u53CA\u65F6\u6027\u627F\u62C5\u8D23\u4EFB\u3002
4. \u7528\u6237\u5E94\u59A5\u5584\u4FDD\u7BA1\u8D26\u53F7\u4FE1\u606F,\u56E0\u8D26\u53F7\u6CC4\u9732\u9020\u6210\u7684\u635F\u5931\u7531\u7528\u6237\u81EA\u884C\u627F\u62C5\u3002
5. \u672C\u63D2\u4EF6\u5C0A\u91CD\u7B2C\u4E09\u65B9\u77E5\u8BC6\u4EA7\u6743,\u5982\u6D89\u53CA\u4FB5\u6743\u8BF7\u8054\u7CFB\u5220\u9664\u3002
6. \u4F7F\u7528\u672C\u63D2\u4EF6\u5373\u8868\u793A\u60A8\u540C\u610F\u672C\u58F0\u660E\u7684\u6240\u6709\u6761\u6B3E,\u5982\u6709\u5F02\u8BAE\u8BF7\u7ACB\u5373\u505C\u6B62\u4F7F\u7528\u3002`},Pe={title:"\u5145\u503C\u5957\u9910",loading:"\u52A0\u8F7D\u4E2D...",loadFailed:"\u52A0\u8F7D\u5931\u8D25",selectPackage:"\u8BF7\u9009\u62E9\u5145\u503C\u5957\u9910",vip:"VIP",points:"\u79EF\u5206",days:"\u5929",discount:"\u4F18\u60E0",originalPrice:"\u539F\u4EF7",currentPrice:"\u73B0\u4EF7",paymentMethod:"\u652F\u4ED8\u65B9\u5F0F",alipay:"\u652F\u4ED8\u5B9D",wechat:"\u5FAE\u4FE1\u652F\u4ED8",submitOrder:"\u63D0\u4EA4\u8BA2\u5355",scanToPay:"\u8BF7\u4F7F\u7528\u624B\u673A\u626B\u7801\u652F\u4ED8",scanWithAlipay:"\u8BF7\u4F7F\u7528\u652F\u4ED8\u5B9D\u626B\u7801",scanWithWechat:"\u8BF7\u4F7F\u7528\u5FAE\u4FE1\u626B\u7801",qrExpired:"\u4E8C\u7EF4\u7801\u5DF2\u5931\u6548",expiresIn:"\u4E8C\u7EF4\u7801\u5C06\u5728 {minutes} \u5206 {seconds} \u79D2\u540E\u5931\u6548",orderId:"\u8BA2\u5355\u53F7",creatingOrder:"\u6B63\u5728\u521B\u5EFA\u8BA2\u5355...",orderCreated:"\u8BA2\u5355\u521B\u5EFA\u6210\u529F",orderFailed:"\u8BA2\u5355\u521B\u5EFA\u5931\u8D25",paymentFailed:"\u652F\u4ED8\u5931\u8D25",highlightTitle:"\u4E00\u952E\u83B7\u53D6\u7B14\u8BB0\u8BE6\u60C5",highlight1:"\u65E0\u8BBA\u89C6\u9891\u591A\u957F\u5B9E\u65F6\u83B7\u53D6\u89C6\u9891\u6587\u6848",highlight2:"\u8282\u7701\u65F6\u95F4\uFF0C\u63D0\u5347\u6548\u7387",highlight3:"\u65E0\u9700\u642D\u914D\u5176\u4ED6\u4ED8\u8D39\u89C6\u9891\u8F6C\u6587\u5B57\u63D2\u4EF6",highlight4:"\u6279\u91CF\u5904\u7406\uFF0C\u4E00\u952E\u91C7\u96C6",highlight5:"\u65E0\u9700\u5B89\u88C5\u63D2\u4EF6\u5B9E\u73B0\u5C0F\u7EA2\u4E66app\u76F4\u63A5\u63A8\u9001\u5230\u98DE\u4E66\u591A\u7EF4\u8868\u683C",limitedTimeOffer:"\u9650\u65F6\u4F18\u60E0\uFF0C\u8DDD\u7ED3\u675F\u4EC5\u5269\uFF1A"},Me={title:ye,subtitle:Fe,userInfo:we,boundTablesList:ve,tableList:xe,tabs:Te,newTable:Ee,existingTable:ke,modal:Ie,buttons:Ce,messages:De,auth:Ae,loading:$e,processing:Se,disclaimer:Le,recharge:Pe},Ue="Xiaohongshu Blogger Notes Extraction",Ne="One-click access to Xiaohongshu blogger notes data, including original images/videos/video text",Oe={user:"User",userName:"Username",userId:"User ID",vipLevel:"VIP Level",remainDownloads:"Remaining Downloads",boundTables:"Bound Tables",expireTime:"Expire Time",normalUser:"Normal User",membershipExpired:"Membership Expired"},ze={title:"Bound Tables List",empty:"No bound tables",tableName:"Table Name",tableId:"Table ID",xhsBinding:"XHS Account Binding",remark:"Remark",bound:"Bound",notBound:"Not Bound",openTable:"Open Table"},je={title:"Data Table Management",noTables:"No tables available",tableId:"Table ID",xhsId:"Xiaohongshu Binding ID",notBound:"Not Bound",remark:"Remark",bound:"Bound",unbound:"Unbound"},Re={existingTables:"Existing Tables",newTable:"New Table"},He={tableName:"Table Name",tableDesc:"Table Description (Optional)",previewTitle:"The following fields will be created automatically"},Xe={selectTable:"Select Table",pleaseSelect:"Please select a table",tableName:"Table Name",tableId:"Table ID",xhsId:"Xiaohongshu ID",remark:"Remark",bound:"Configured",notBound:"Auto Push Not Configured"},Ve={bindTitle:"Push Settings",editTitle:"Edit Auto Push Settings",tableName:"Table Name",personalBaseToken:"Personal Base Token",personalBaseTokenHint:"Unique identifier for each base table",xhsUrl:"Xiaohongshu Binding (Supports mobile push notifications after binding)",xhsUrlHint:"Supports xiaohongshu.com or xhslink.com URLs, or directly input 24-character XHS ID",remark:"Remark (Optional)",fieldSelection:"Field Selection",fieldSelectionHint:"Select fields to collect. Unselected fields will not be populated with data.",selectAll:"Select All",deselectAll:"Clear All",extractedInfo:"Extracted Information",appToken:"App Token",tableId:"Table ID",xhsId:"XHS ID"},_e={refresh:"Refresh",activate:"Activate",renew:"Renew",bind:"Push Settings",edit:"Edit Settings",unbind:"Remove Settings",save:"Save",cancel:"Cancel",close:"Close",chatGroup:"Chat Group",support:"Support",createTable:"Create Table",startProcessing:"Start Fetching Blogger Notes",help:"Help"},Ge={saving:"Saving...",saveSuccess:"Saved successfully",saveFailed:"Save failed",fieldSelectionSaved:"Default field selection saved",unbinding:"Unbinding...",unbindSuccess:"Unbound successfully",unbindFailed:"Unbind failed",confirmUnbind:"After unbinding, you will not receive push messages. Are you sure you want to unbind this table?",pleaseLoginFirst:"Please re-login to get authorization",cannotGetBaseInfo:"Cannot get base information",openModalFailed:"Failed to open binding dialog",invalidUrl:"Invalid URL",pleaseInputPersonalBaseToken:"Please input Personal Base Token",pleaseInputXhsUrl:"Please input Xiaohongshu homepage URL",extractXhsIdFailed:"Failed to extract XHS ID",refreshingUserInfo:"Refreshing user information...",userInfoRefreshSuccess:"User information refreshed successfully",refreshFailed:"Refresh failed",authorizationExpired:"Authorization has expired, please re-login",unknownError:"Unknown error",pleaseSelectTableFirst:"Please select a table first",loadTableListFailed:"Failed to load table list",updating:"Updating...",updateSuccess:"Updated successfully",updateFailed:"Update failed"},We={failed:"Authorization Failed",failedMessage:"Unable to verify your authorization information. Please provide the following information to the administrator",tenantKey:"Tenant Key"},Ke={verifying:"Verifying authorization..."},qe={hint:"Automatically fetch all blogger notes and add to table"},Je={title:"Disclaimer",content:`1. This plugin is for personal learning and research purposes only, not for any commercial use.
2. Users using this plugin to collect data should comply with Xiaohongshu platform's relevant regulations and user agreements.
3. This plugin is not responsible for the accuracy, completeness, and timeliness of collected content.
4. Users should properly safeguard account information, and losses caused by account leaks shall be borne by the users themselves.
5. This plugin respects third-party intellectual property rights, please contact for removal if involved in infringement.
6. Using this plugin indicates that you agree to all terms of this statement, please stop using immediately if you have any objections.`},Qe={title:"Recharge Packages",loading:"Loading...",loadFailed:"Failed to load",selectPackage:"Please select a package",vip:"VIP",points:"Points",days:"days",discount:"Discount",originalPrice:"Original Price",currentPrice:"Current Price",paymentMethod:"Payment Method",alipay:"Alipay",wechat:"WeChat Pay",submitOrder:"Submit Order",scanToPay:"Please scan to pay with mobile",scanWithAlipay:"Please scan with Alipay",scanWithWechat:"Please scan with WeChat",qrExpired:"QR code expired",expiresIn:"QR code expires in {minutes} min {seconds} sec",orderId:"Order ID",creatingOrder:"Creating order...",orderCreated:"Order created successfully",orderFailed:"Failed to create order",paymentFailed:"Payment failed",highlightTitle:"One-Click Note Extraction",highlight1:"Real-time video text extraction regardless of video length",highlight2:"Save time, boost efficiency",highlight3:"No need for other paid video-to-text plugins",highlight4:"Batch processing, one-click collection",highlight5:"No plugin needed - direct push from Xiaohongshu app to Feishu base tables",limitedTimeOffer:"Limited time offer, ends in:"},Ze={title:Ue,subtitle:Ne,userInfo:Oe,boundTablesList:ze,tableList:je,tabs:Re,newTable:He,existingTable:Xe,modal:Ve,buttons:_e,messages:Ge,auth:We,loading:Ke,processing:qe,disclaimer:Je,recharge:Qe};c.use(Be).init({resources:{zh:{translation:Me},en:{translation:Ze}},fallbackLng:"zh",debug:!1,interpolation:{escapeValue:!1}}).then(()=>{me.init(c,e,{tName:"t",i18nName:"i18n",handleName:"localize",selectorAttr:"data-i18n",targetAttr:"i18n-target",optionsAttr:"i18n-options",parseOptionsFromContent:!0}),re()});function re(){e("[data-i18n]").localize(),document.title=c.t("title"),document.documentElement.lang=c.language}const Ye={info:'<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',success:'<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',warning:'<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',error:'<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',loading:'<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>'};function d(t,a="info",r){const u=document.getElementById("toastContainer");if(!u)return;r&&r.parentNode&&r.parentNode.removeChild(r);const o=document.createElement("div");return o.className=`toast ${a}`,o.innerHTML=`
    <div class="toast-icon">${Ye[a]}</div>
    <div class="toast-message">${t}</div>
  `,u.appendChild(o),a!=="loading"&&setTimeout(()=>{o.classList.add("hiding"),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300)},3e3),o}function et(){const t=document.getElementById("loadingOverlay");t&&t.classList.add("active")}function tt(){const t=document.getElementById("loadingOverlay");t&&t.classList.remove("active")}function ot(t){localStorage.setItem("xhsnote_token",t)}function R(){return localStorage.getItem("xhsnote_token")}function Z(t){localStorage.setItem("xhsnote_user_info",JSON.stringify(t))}function pe(){const t=localStorage.getItem("xhsnote_user_info");if(t)try{return JSON.parse(t)}catch(a){console.error("Failed to parse saved user info:",a)}return null}async function J(t){e("#userId").text(t.userId||"-"),t.remainDownload!==void 0&&t.remainDownload!==null?(e("#remainDownload").text(t.remainDownload),t.remainDownload<=0?e("#remainDownload").css("color","#ff4d4f"):t.remainDownload<10?e("#remainDownload").css("color","#faad14"):e("#remainDownload").css("color","#52c41a")):e("#remainDownload").text("-");try{const a=R();if(a){const r=await fetch("https://shop.leshangyundian.com/feishu/api/table/list",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(r.ok){const u=await r.json(),o=u.data||u,h=Array.isArray(o)?o.length:0;e("#boundTableCount").text(h)}else e("#boundTableCount").text("-")}else e("#boundTableCount").text("-")}catch(a){console.error("Failed to fetch bound table count:",a),e("#boundTableCount").text("-")}e("#userInfo").show(),e("#boundTableCount").css("cursor","pointer").css("text-decoration","underline")}async function nt(){try{const t=R();if(!t){d(c.t("messages.pleaseLoginFirst"),"error");return}const a=await fetch("https://shop.leshangyundian.com/feishu/api/table/list",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`}});if(!a.ok){d(c.t("messages.loadTableListFailed"),"error");return}const r=await a.json(),u=r.data||r;if(!Array.isArray(u)||u.length===0)e("#boundTablesList").html(`<div style="text-align: center; padding: 40px; color: #999;">${c.t("boundTablesList.empty")}</div>`);else{const o=await L.base.getSelection(),h=(o==null?void 0:o.baseId)||"";let y='<div style="display: flex; flex-direction: column; gap: 12px;">';u.forEach(D=>{const P=D.tableName||"-",U=D.tableId||"-",O=D.remark||"-",_=D.appToken||h,V=D.xhsId||"",te=D.xhsUrl||"",G=!!(V||te),oe=G?`<span style="color: #52c41a; font-weight: 500;">${c.t("boundTablesList.bound")}</span>`:`<span style="color: #999;">${c.t("boundTablesList.notBound")}</span>`,ne=G?`<div style="font-size: 12px; color: #999; margin-top: 4px;">XHS ID: <span style="font-family: monospace; color: #666;">${V||"-"}</span></div>`:"",se=`https://feishu.cn/base/${_}?table=${U}`;y+=`
          <div style="border: 1px solid #e8e8e8; border-radius: 8px; padding: 16px; background: #fafafa;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 12px; color: #999; margin-bottom: 4px;">${c.t("boundTablesList.tableName")}</div>
                <div style="font-size: 14px; font-weight: 600; color: #333; word-break: break-all;">${P}</div>
              </div>
              <a href="${se}" target="_blank" class="button button-primary button-small" style="text-decoration: none; padding: 6px 12px; font-size: 12px; white-space: nowrap;">
                ${c.t("boundTablesList.openTable")}
              </a>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <div style="font-size: 12px; color: #999; margin-bottom: 4px;">${c.t("boundTablesList.tableId")}</div>
                <div style="font-size: 13px; color: #666; font-family: monospace; word-break: break-all;">${U}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #999; margin-bottom: 4px;">${c.t("boundTablesList.xhsBinding")}</div>
                <div style="font-size: 13px;">${oe}</div>
                ${ne}
              </div>
            </div>
            ${O&&O!=="-"?`
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e8e8e8;">
              <div style="font-size: 12px; color: #999; margin-bottom: 4px;">${c.t("boundTablesList.remark")}</div>
              <div style="font-size: 13px; color: #666; word-break: break-all;">${O}</div>
            </div>
            `:""}
          </div>
        `}),y+="</div>",e("#boundTablesList").html(y)}e("#boundTablesModal").addClass("active")}catch(t){console.error("Failed to load bound tables list:",t),d(c.t("messages.loadTableListFailed"),"error")}}function st(){e("#boundTablesModal").removeClass("active")}async function at(){try{const t=await L.bridge.getTenantKey(),a=await L.bridge.getBaseUserId();if(!t||!a)return console.error("Missing tenant key or user ID"),{success:!1};const r=new FormData;r.append("tenantKey",t),r.append("userId",a);const u=await fetch("https://shop.leshangyundian.com/feishu/user/login",{method:"POST",body:r});if(u.ok){const o=await u.json();return o.success===!0&&o.data?(ot(o.data.token),Z(o.data),await J(o.data),{success:!0,data:o.data}):{success:!1}}else return console.error("Authorization failed:",u.status,u.statusText),{success:!1}}catch(t){return console.error("Authorization error:",t),{success:!1}}}async function ue(t){try{let a=t.trim();const r=a.match(/^([a-zA-Z0-9]{24})$/);if(r&&r[1])return r[1];if(a.includes("xhslink.com"))try{const o=await fetch(a,{method:"GET",redirect:"manual"});o.headers.has("location")&&(a=o.headers.get("location")||a)}catch(o){console.warn("Failed to resolve xhslink.com redirect:",o)}const u=a.match(/user\/profile\/([a-zA-Z0-9]{24})/);if(u&&u[1])return u[1];throw new Error("Invalid XHS URL format")}catch(a){throw console.error("Error extracting XHS ID:",a),a}}function it(t,a){const r=e("#existingTableSelect"),u=e("#singleTableSelect"),o=e("#selectedTableInfo");if(r.find("option:not(:first)").remove(),u.find("option:not(:first)").remove(),o.hide(),!t||t.length===0){r.prop("disabled",!0),u.prop("disabled",!0);return}r.prop("disabled",!1),u.prop("disabled",!1),t.forEach(h=>{const D=!!a.get(h.id),P=D?"\u3010"+c.t("existingTable.bound")+"\u3011":"\u3010"+c.t("existingTable.notBound")+"\u3011",U=e(`
      <option value="${h.id}" data-bound="${D}">
        ${P} ${h.name}
      </option>
    `);r.append(U)}),t.forEach(h=>{const y=e(`
      <option value="${h.id}">
        ${h.name}
      </option>
    `);u.append(y)}),window.tablesData=t,window.boundTablesData=a}async function le(){const t=e("#existingTableSelect").val();if(!t)return;const r=window.tablesData.find(u=>u.id===t);!r||console.log(`\u5DF2\u9009\u62E9\u8868\u683C: ${r.name} (${t})`)}const K=[{key:"noteId",label:"\u7B14\u8BB0ID",type:1},{key:"authorNickname",label:"\u535A\u4E3B\u6635\u79F0",type:1},{key:"authorRedId",label:"\u5C0F\u7EA2\u4E66\u53F7",type:1},{key:"bloggerHomepage",label:"\u535A\u4E3B\u4E3B\u9875",type:15},{key:"sticky",label:"\u7F6E\u9876\u6807\u8BC6",type:3},{key:"type",label:"\u7B14\u8BB0\u7C7B\u578B",type:3},{key:"title",label:"\u7B14\u8BB0\u6807\u9898",type:1},{key:"description",label:"\u7B14\u8BB0\u5185\u5BB9",type:1},{key:"imageAttachments",label:"\u56FE\u7247\u5217\u8868",type:17},{key:"tags",label:"\u8BDD\u9898",type:4},{key:"likes",label:"\u70B9\u8D5E\u6570",type:2},{key:"collects",label:"\u6536\u85CF\u6570",type:2},{key:"shares",label:"\u8F6C\u53D1\u6570",type:2},{key:"comments",label:"\u8BC4\u8BBA\u6570",type:2},{key:"videoUrl",label:"\u89C6\u9891\u5730\u5740",type:15},{key:"videoDuration",label:"\u89C6\u9891\u65F6\u957F(\u79D2)",type:2},{key:"videoSubtitle",label:"\u89C6\u9891\u5B57\u5E55",type:1},{key:"videoText",label:"\u89C6\u9891\u6587\u672C",type:1},{key:"publishTime",label:"\u53D1\u5E03\u65F6\u95F4",type:1},{key:"fetchTime",label:"\u83B7\u53D6\u65F6\u95F4",type:1},{key:"source",label:"\u6570\u636E\u6765\u6E90",type:1}];function ce(t){const a=e("#fieldSelectionContainer");a.empty();const r=new Set;t&&t.split(",").forEach(o=>{o&&r.add(o.trim())});const u=r.size===0;K.forEach(o=>{const h=u||r.has(o.key),y=e(`
      <div class="field-checkbox-item">
        <input type="checkbox" id="field_${o.key}" value="${o.key}" ${h?"checked":""}>
        <label for="field_${o.key}">${o.label}</label>
      </div>
    `);a.append(y)})}function rt(){const t=[];return e('#fieldSelectionContainer input[type="checkbox"]:checked').each(function(){const a=e(this).val();a&&t.push(String(a))}),t.join(",")}function ie(){const t=[];return e('.fields-showcase-grid input[type="checkbox"]:checked').each(function(){const a=e(this).val();a&&e(this).closest(".field-item").is(":visible")&&t.push(String(a))}),t.join(",")}function ut(){const t=localStorage.getItem("defaultFieldSelection");if(t){const a=t.split(",");e('.fields-showcase-grid input[type="checkbox"]').each(function(){const r=e(this).val();e(this).prop("checked",a.includes(r))})}}window.openBindModal=async function(t,a){try{const r=await L.base.getSelection();if(!r||!r.baseId){d(c.t("messages.cannotGetBaseInfo"),"error");return}const o=(await ee()).get(t);e("#bindAppToken").val(r.baseId),e("#bindTableId").val(t),e("#bindTableName").val(a),e("#tableNameDisplay").val(a),e("#displayAppToken").text(r.baseId),e("#displayTableId").text(t),o&&o.id?(e("#modalTitle").text(c.t("modal.editTitle")),e("#bindTableId").data("bindingId",o.id),e("#personalBaseToken").val(o.personalBaseToken||""),e("#remark").val(o.remark||""),o.xhsUrl?e("#xhsUrl").val(o.xhsUrl):o.xhsId?e("#xhsUrl").val(o.xhsId):e("#xhsUrl").val(""),o.xhsId?e("#displayXhsId").text(o.xhsId):e("#displayXhsId").text("-"),ce(o.fields)):(e("#modalTitle").text(c.t("modal.bindTitle")),e("#bindTableId").data("bindingId",null),e("#personalBaseToken").val(""),e("#xhsUrl").val(""),e("#remark").val(""),e("#displayXhsId").text("-"),ce()),e("#bindModal").addClass("active")}catch(r){console.error("Error opening bind modal:",r),d(c.t("messages.openModalFailed"),"error")}};window.closeBindModal=function(){e("#bindModal").removeClass("active")};window.closeBoundTablesModal=st;let Y=null,N=null,X=null,j=null;function lt(){const t=Math.floor(Math.random()*6)+1,a=Math.floor(Math.random()*60),r=Math.floor(Math.random()*60),u=new Date().getTime()+t*60*60*1e3+a*60*1e3+r*1e3,o=()=>{const h=new Date().getTime(),y=u-h;if(y<0){e("#promoCountdown").text("00:00:00"),X&&(clearInterval(X),X=null);return}const D=Math.floor(y%(1e3*60*60*24)/(1e3*60*60)),P=Math.floor(y%(1e3*60*60)/(1e3*60)),U=Math.floor(y%(1e3*60)/1e3);e("#promoCountdown").text(`${String(D).padStart(2,"0")}:${String(P).padStart(2,"0")}:${String(U).padStart(2,"0")}`)};o(),X=window.setInterval(o,1e3)}async function ge(){try{const t=R();if(!t){d(c.t("messages.pleaseLoginFirst"),"error");return}Y=null,N&&(clearInterval(N),N=null),X&&(clearInterval(X),X=null),e("#paymentMethodSection").hide(),e("#paymentQrSection").hide(),e("#productsList").html(`<div style="text-align: center; padding: 40px; color: #999;">${c.t("recharge.loading")}</div>`),e("#rechargeModal").addClass("active"),lt();const a=await fetch("https://shop.leshangyundian.com/feishu/user/recharge-products?type=NOTE",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`}});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const r=await a.json();if(!r.success&&r.code!==200||!r.data||!Array.isArray(r.data))throw new Error("Invalid response format");const u=r.data;if(u.length===0){e("#productsList").html(`<div style="text-align: center; padding: 40px; color: #999;">${c.t("recharge.loadFailed")}</div>`);return}let o="";u.forEach(h=>{const y=h.discount&&h.discount>0;let D="",P="";const U=h.title.match(/(\d+)\s*积分/),O=U?U[1]:"";h.type==="VIP"?(D=c.t("recharge.vip"),P="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"):(h.type==="NOTE"||h.type==="POINTS")&&(D="",P=""),o+=`
        <div class="product-card" data-product-id="${h.id}" style="
          border: 2px solid #e8e8e8;
          border-radius: 12px;
          padding: 16px;
          cursor: pointer;
          transition: all 0.3s;
          background: white;
          position: relative;
          text-align: center;
        ">
          ${y?`<div style="position: absolute; top: 8px; right: 8px; background: linear-gradient(135deg, #ff6b6b 0%, #ff4d4f 100%); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; box-shadow: 0 2px 4px rgba(255, 77, 79, 0.3);">-${h.discount}%</div>`:""}

          <div style="margin-bottom: 12px;">
            ${O?`
            <div style="font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 4px;">
              ${O}
            </div>
            <div style="font-size: 13px; color: #999; font-weight: 500;">\u79EF\u5206</div>
            `:`
            <div style="font-size: 14px; font-weight: 600; color: #333; line-height: 1.4;">${h.title}</div>
            `}
          </div>

          <div style="display: flex; align-items: baseline; justify-content: center; gap: 6px; padding-top: 8px; border-top: 1px solid #f0f0f0;">
            <span style="font-size: 24px; font-weight: 700; color: #ff4d4f;">\xA5${h.price.toFixed(2)}</span>
            ${y?`<span style="font-size: 13px; color: #999; text-decoration: line-through;">\xA5${h.originalPrice.toFixed(2)}</span>`:""}
          </div>
        </div>
      `}),e("#productsList").html(o),e(".product-card").on("click",function(){e(".product-card").css("border-color","#e8e8e8").css("background","white"),e(this).css("border-color","#ff4d4f").css("background","#fff5f5"),Y=parseInt(e(this).data("product-id")),e("#paymentMethodSection").slideDown()})}catch(t){console.error("Failed to load recharge products:",t),d(c.t("recharge.loadFailed")+": "+(t instanceof Error?t.message:String(t)),"error"),e("#productsList").html(`<div style="text-align: center; padding: 40px; color: #999;">${c.t("recharge.loadFailed")}</div>`)}}function he(){N&&(clearInterval(N),N=null),X&&(clearInterval(X),X=null),j&&(clearInterval(j),j=null),e("#rechargeModal").removeClass("active")}async function ct(){if(!Y){d(c.t("recharge.selectPackage"),"warning");return}const t=R(),a=pe();if(!t||!a){d(c.t("messages.pleaseLoginFirst"),"error");return}const r=e('input[name="paymentType"]:checked').val();try{const u=d(c.t("recharge.creatingOrder"),"loading"),o=await fetch(`https://shop.leshangyundian.com/feishu/user/createorder?token=${t}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({productId:String(Y),userId:a.userId,paymentType:r})});if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const h=await o.json();if(!h.success||!h.data)throw new Error(h.msg||c.t("recharge.orderFailed"));d(c.t("recharge.orderCreated"),"success",u);const y=h.data,D=y.tradeOrderId,P=y.totalAmount,U=await fetch(`https://shop.leshangyundian.com/feishu/user/pay?token=${t}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({orderId:D,paymentType:r})});if(!U.ok)throw new Error(`HTTP ${U.status}: ${U.statusText}`);const O=await U.json();if(!O.success||!O.data)throw new Error(O.msg||c.t("recharge.paymentFailed"));const _=O.data;e("#paymentQrCode").attr("src",_.qrCodeImage),e("#displayOrderId").text(D),P!=null&&e("#paymentAmount").text(`\xA5${Number(P).toFixed(2)}`);const V=r==="alipay"?c.t("recharge.scanWithAlipay"):c.t("recharge.scanWithWechat");e("#paymentMethodHint").text(V),e("#paymentMethodSection").hide(),e("#paymentQrSection").fadeIn(),gt(300),pt(D,t)}catch(u){console.error("Failed to create order or get payment:",u),d(u instanceof Error?u.message:String(u),"error")}}async function dt(t,a){try{const r=await fetch(`https://shop.leshangyundian.com/feishu/user/order-status/${t}?token=${a}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(!r.ok)return console.error("Order status check failed:",r.status),{status:0};const u=await r.json();return u.success&&u.data?{status:u.data.status,data:u.data}:{status:0}}catch(r){return console.error("Order status check error:",r),{status:0}}}function pt(t,a){j&&clearInterval(j),de(t,a),j=window.setInterval(()=>{de(t,a)},3e3)}async function de(t,a){var u,o;const r=await dt(t,a);if(r.status===1){j&&(clearInterval(j),j=null),N&&(clearInterval(N),N=null),e("#paymentQrSection").html(`
      <div style="text-align: center; padding: 40px;">
        <svg width="80" height="80" fill="none" stroke="#52c41a" viewBox="0 0 24 24" style="margin-bottom: 20px;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 style="font-size: 24px; font-weight: 600; color: #52c41a; margin-bottom: 12px;">\u652F\u4ED8\u6210\u529F\uFF01</h3>
        <p style="font-size: 16px; color: #666; margin-bottom: 8px;">${((u=r.data)==null?void 0:u.itemName)||"\u5145\u503C\u6210\u529F"}</p>
        <p style="font-size: 14px; color: #999;">\u83B7\u5F97\u989D\u5EA6: ${((o=r.data)==null?void 0:o.itemValue)||"-"}</p>
        <button onclick="closeRechargeModal()" style="
          margin-top: 24px;
          padding: 12px 32px;
          font-size: 16px;
          font-weight: 600;
          background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s;
        ">\u5173\u95ED</button>
      </div>
    `);const h=await fetch("https://shop.leshangyundian.com/feishu/user/info",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(h.ok){const y=await h.json();y.success===!0&&y.data&&(Z(y.data),await J(y.data))}d("\u5145\u503C\u6210\u529F\uFF01","success")}else r.status===-1&&(j&&(clearInterval(j),j=null),N&&(clearInterval(N),N=null),d("\u8BA2\u5355\u5DF2\u53D6\u6D88","warning"),he())}function gt(t){let a=t;const r=()=>{if(a<=0){N&&(clearInterval(N),N=null),j&&(clearInterval(j),j=null),e("#paymentQrSection").html(`
        <div style="text-align: center; padding: 40px;">
          <svg width="80" height="80" fill="none" stroke="#ff4d4f" viewBox="0 0 24 24" style="margin-bottom: 20px;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <h3 style="font-size: 24px; font-weight: 600; color: #ff4d4f; margin-bottom: 12px;">\u652F\u4ED8\u8D85\u65F6</h3>
          <p style="font-size: 16px; color: #666;">\u4E8C\u7EF4\u7801\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u91CD\u65B0\u4E0B\u5355</p>
          <button onclick="closeRechargeModal()" style="
            margin-top: 24px;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
          ">\u5173\u95ED</button>
        </div>
      `),d("\u652F\u4ED8\u8D85\u65F6\uFF0C\u4E8C\u7EF4\u7801\u5DF2\u8FC7\u671F","warning");return}const u=Math.floor(a/60),o=a%60,h=`${c.t("recharge.expiresIn").replace("{minutes}",String(u).padStart(2,"0")).replace("{seconds}",String(o).padStart(2,"0"))}`;e("#countdownTimer").text(h),a--};r(),N=window.setInterval(r,1e3)}window.openRechargeModal=ge;window.closeRechargeModal=he;async function ht(){const t=e("#xhsUrl").val();if(!t){e("#displayXhsId").text("-");return}try{const a=await ue(t);e("#displayXhsId").text(a)}catch{e("#displayXhsId").text(c.t("messages.invalidUrl")),d(c.t("messages.invalidUrl"),"warning")}}async function ee(){const t=new Map;try{const a=R();if(!a)return console.warn("[loadBoundTables] No token available"),t;const r=await L.base.getSelection();if(!r||!r.baseId)return console.warn("[loadBoundTables] No baseId available"),t;const u=await fetch(`https://shop.leshangyundian.com/feishu/api/table/list?appToken=${r.baseId}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(u.ok){const o=await u.json();console.log("[loadBoundTables] API Response:",o);const h=o.data||o;Array.isArray(h)&&(h.forEach(y=>{y.fields&&Array.isArray(y.fields)&&(y.fields=y.fields.join(",")),t.set(y.tableId,y)}),console.log(`[loadBoundTables] Loaded ${t.size} bound tables`))}else console.error("[loadBoundTables] HTTP Error:",u.status,u.statusText)}catch(a){console.error("[loadBoundTables] Error:",a)}return t}async function ft(t){try{const a=R();if(!a)return d(c.t("messages.pleaseLoginFirst"),"error"),!1;const r=d(c.t("messages.saving"),"loading"),u=await fetch("https://shop.leshangyundian.com/feishu/api/table/save",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(t)});if(u.ok){const o=await u.json();if(o.success===!0)return d(c.t("messages.saveSuccess"),"success",r),!0;{const h=o.msg||o.message||c.t("messages.saveFailed");return d(h,"error",r),!1}}else return d(`${c.t("messages.saveFailed")}: ${u.statusText}`,"error",r),!1}catch(a){return d(`${c.t("messages.saveFailed")}: ${a}`,"error"),!1}}window.unbindTable=async function(t){const r=(await ee()).get(t);if(!r||!r.id){d("\u672A\u627E\u5230\u7ED1\u5B9A\u8BB0\u5F55","error");return}if(!!confirm(c.t("messages.confirmUnbind")))try{const u=R();if(!u){d(c.t("messages.pleaseLoginFirst"),"error");return}const o=d(c.t("messages.unbinding"),"loading"),h=await fetch(`https://shop.leshangyundian.com/feishu/api/table/delete/${r.id}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`}});if(h.ok){const y=await h.json();if(y.success===!0)d(c.t("messages.unbindSuccess"),"success",o),await q();else{const D=y.msg||y.message||c.t("messages.unbindFailed");d(D,"error",o)}}else d(`${c.t("messages.unbindFailed")}: ${h.statusText}`,"error",o)}catch(u){console.error("Error unbinding table:",u),d(`${c.t("messages.unbindFailed")}: ${u}`,"error")}};async function q(){try{const t=await L.base.getTableMetaList(),a=await ee();it(t,a)}catch(t){console.error("Error refreshing table list:",t),d(c.t("messages.loadTableListFailed"),"error")}}e(document).ready(async function(){window.addEventListener("error",function(n){console.error("Uncaught error:",n.error)}),window.addEventListener("unhandledrejection",function(n){console.error("Unhandled promise rejection:",n.reason)});try{if(typeof L>"u")console.error("Bitable API not available"),setTimeout(()=>{window.location.href="https://feishu.cn"},1e3);else try{const n=await L.bridge.getEnv();(!n.product||n.product!=="feishu"&&n.product!=="lark")&&(console.error("Not in Feishu or Lark environment"),setTimeout(()=>{window.location.href="https://feishu.cn"},1e3))}catch(n){console.warn("Environment check failed, but continuing:",n)}}catch(n){console.error("Environment check encountered error:",n)}const t=pe();if(t&&await J(t),ut(),et(),!(await at()).success){let n="",i="";try{const s=await L.bridge.getTenantKey(),g=await L.bridge.getBaseUserId();n=s||"\u65E0\u6CD5\u83B7\u53D6",i=g||"\u65E0\u6CD5\u83B7\u53D6"}catch(s){console.error("Failed to get debug info:",s)}e("body").html(`
      <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #ffeef2 0%, #ffe4e8 100%);">
        <div style="text-align: center; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(255, 107, 107, 0.2); max-width: 700px;">
          <div style="font-size: 64px; margin-bottom: 20px;">\u{1F614}</div>
          <h1 style="color: #ff2442; margin-bottom: 16px;" data-i18n="auth.failed">${c.t("auth.failed")}</h1>
          <p style="color: #666; margin-bottom: 24px;" data-i18n="auth.failedMessage">${c.t("auth.failedMessage")}</p>

          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 24px; text-align: left;">
            <p style="margin: 0 0 10px 0;"><strong>Tenant Key:</strong></p>
            <code style="display: block; background: white; padding: 10px; border-radius: 6px; word-break: break-all; color: #ff2442;">${n}</code>

            <p style="margin: 20px 0 10px 0;"><strong>Base User ID:</strong></p>
            <code style="display: block; background: white; padding: 10px; border-radius: 6px; word-break: break-all; color: #ff2442;">${i}</code>
          </div>

          <button onclick="location.reload()" style="padding: 12px 32px; background: linear-gradient(135deg, #ff2442 0%, #ff6b6b 100%); color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; transition: transform 0.2s; margin-right: 12px;">
            \u91CD\u65B0\u52A0\u8F7D
          </button>
        </div>
      </div>
    `);return}tt(),await q(),e("#xhsUrl").on("input",async function(){await ht()}),e("#bindForm").on("submit",async function(n){n.preventDefault();try{const i=e("#bindAppToken").val(),s=e("#bindTableId").val(),g=e("#bindTableName").val(),p=e("#personalBaseToken").val(),l=e("#xhsUrl").val(),f=e("#remark").val(),E=rt(),T=e("#bindTableId").data("bindingId");if(!p.trim()){d(c.t("messages.pleaseInputPersonalBaseToken"),"error");return}let k="";if(l.trim())try{k=await ue(l)}catch{d(c.t("messages.extractXhsIdFailed"),"error");return}let z="";try{const w=await L.base.getSelection();if(w&&w.baseId){z=`https://feishu.cn/base/${w.baseId}`;try{(await L.bridge.getEnv()).product==="lark"&&(z=`https://larksuite.com/base/${w.baseId}`)}catch(m){console.warn("Failed to check environment:",m)}}}catch(w){console.warn("Failed to get base URL:",w)}const x={appToken:i,tableId:s,tableName:g,personalBaseToken:p,xhsUrl:l.trim(),xhsId:k,remark:f||"",fields:E,baseUrl:z};T&&(x.id=T),await ft(x)&&(window.closeBindModal(),await q())}catch(i){console.error("Error submitting bind form:",i),d(c.t("messages.extractXhsIdFailed"),"error")}}),e("#refreshUserInfo").on("click",async function(){const n=R();if(!n){d(c.t("messages.pleaseLoginFirst"),"error");return}const i=e(this),s=i.find("svg");i.prop("disabled",!0),s.css("animation","spin 1s linear infinite");try{const g=d(c.t("messages.refreshingUserInfo"),"loading"),p=await fetch("https://shop.leshangyundian.com/feishu/user/info",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`}});if(p.ok){const l=await p.json();l.success===!0&&l.data?(Z(l.data),await J(l.data),d(c.t("messages.userInfoRefreshSuccess"),"success",g)):(d(c.t("messages.refreshFailed")+": "+(l.message||c.t("messages.unknownError")),"error",g),p.status===401&&(localStorage.removeItem("xhsnote_token"),localStorage.removeItem("xhsnote_user_info"),d(c.t("messages.authorizationExpired"),"error")))}else throw new Error(`HTTP ${p.status}: ${p.statusText}`)}catch(g){console.error("Refresh user info error:",g),d(c.t("messages.refreshFailed")+": "+(g instanceof Error?g.message:String(g)),"error")}finally{i.prop("disabled",!1),s.css("animation","")}}),e("#boundTableCount").on("click",function(){nt()}),e("#rechargeDownloadsBtn").on("click",function(){ge()}),e("#selectAllFieldsBtn").on("click",function(){e('.fields-showcase-grid input[type="checkbox"]').prop("checked",!0)}),e("#deselectAllFieldsBtn").on("click",function(){e('.fields-showcase-grid input[type="checkbox"]').prop("checked",!1)}),e(".fields-showcase-grid").on("click",".field-item",function(n){if(n.target.classList.contains("field-checkbox"))return;const i=e(this).find(".field-checkbox");i.prop("checked",!i.prop("checked"))}),e("#submitOrderBtn").on("click",function(){ct()}),e("#saveFieldSelectionBtn").on("click",async function(){const n=ie(),i=e("#existingTableSelect").val();if(i){const g=(await ee()).get(i);if(g&&g.id){const p=d("\u6B63\u5728\u66F4\u65B0\u5B57\u6BB5\u914D\u7F6E...","loading");try{const l=R();if(!l){d("\u8BF7\u5148\u767B\u5F55","error",p);return}let f="";try{const k=await L.base.getSelection();if(k&&k.baseId){f=`https://feishu.cn/base/${k.baseId}`;try{(await L.bridge.getEnv()).product==="lark"&&(f=`https://larksuite.com/base/${k.baseId}`)}catch(z){console.warn("Failed to check environment:",z)}}}catch(k){console.warn("Failed to get base URL:",k)}const E={...g,fields:n,baseUrl:f},T=await fetch("https://shop.leshangyundian.com/feishu/api/table/save",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(E)});if(T.ok){const k=await T.json();k.success===!0?(d("\u5B57\u6BB5\u914D\u7F6E\u5DF2\u66F4\u65B0\u5230\u8868\u683C","success",p),await q(),e("#existingTableSelect").val(i),await le()):d("\u66F4\u65B0\u5931\u8D25: "+(k.msg||k.message||"\u672A\u77E5\u9519\u8BEF"),"error",p)}else d(`\u66F4\u65B0\u5931\u8D25: ${T.statusText}`,"error",p)}catch(l){console.error("\u66F4\u65B0\u5B57\u6BB5\u914D\u7F6E\u5931\u8D25:",l),d("\u66F4\u65B0\u5931\u8D25: "+(l instanceof Error?l.message:String(l)),"error",p)}return}}localStorage.setItem("defaultFieldSelection",n),d(c.t("messages.fieldSelectionSaved"),"success")});let r=!1,u=!1,o="blogger";e("#tabBlogger").on("click",function(){o="blogger",e("#tabBlogger").addClass("tab-active"),e("#tabSingle").removeClass("tab-active"),e("#tabAutoPush").removeClass("tab-active"),e("#bloggerTabContent").show(),e("#singleTabContent").hide(),e("#autoPushTabContent").hide(),e("#startProcessingBtn").text("\u5F00\u59CB\u6839\u636E\u535A\u4E3B\u4E3B\u9875\u83B7\u53D6"),e("#buttonHint").text("\u5C06\u81EA\u52A8\u83B7\u53D6\u535A\u4E3B\u7684\u6240\u6709\u7B14\u8BB0\u5E76\u6DFB\u52A0\u5230\u8868\u683C"),e("#fieldsHint").html("\u{1F4A1} \u6839\u636E\u535A\u4E3B\u4E3B\u9875\u83B7\u53D6\uFF1A\u7B14\u8BB0\u5185\u5BB9\u548C\u8BDD\u9898\u4E3A\u90E8\u5206\u6570\u636E"),e("#bloggerHomepageField").show()}),e("#tabSingle").on("click",function(){o="single",e("#tabSingle").addClass("tab-active"),e("#tabBlogger").removeClass("tab-active"),e("#tabAutoPush").removeClass("tab-active"),e("#singleTabContent").show(),e("#bloggerTabContent").hide(),e("#autoPushTabContent").hide(),e("#startProcessingBtn").text("\u5F00\u59CB\u5B8C\u6574\u6570\u636E\u83B7\u53D6"),e("#buttonHint").text("\u5C06\u6839\u636E\u7B14\u8BB0ID\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u5E76\u66F4\u65B0\u8868\u683C\u6570\u636E"),e("#fieldsHint").html("\u{1F4A1} \u5B8C\u6574\u6570\u636E\u83B7\u53D6\uFF1A\u7B14\u8BB0\u5185\u5BB9\u548C\u8BDD\u9898\u4E3A\u5B8C\u6574\u6570\u636E"),e("#bloggerHomepageField").hide()}),e("#tabAutoPush").on("click",function(){o="autoPush",e("#tabAutoPush").addClass("tab-active"),e("#tabBlogger").removeClass("tab-active"),e("#tabSingle").removeClass("tab-active"),e("#autoPushTabContent").show(),e("#bloggerTabContent").hide(),e("#singleTabContent").hide(),e("#startProcessingBtn").text("\u5F00\u59CB\u81EA\u52A8\u63A8\u9001"),e("#buttonHint").text("\u81EA\u52A8\u63A8\u9001\u529F\u80FD\u5F00\u53D1\u4E2D\uFF0C\u656C\u8BF7\u671F\u5F85"),e("#fieldsHint").html("\u{1F4A1} \u81EA\u52A8\u63A8\u9001\uFF1A\u529F\u80FD\u5F00\u53D1\u4E2D\uFF0C\u656C\u8BF7\u671F\u5F85"),e("#bloggerHomepageField").show()}),e("#singleTableSelect").on("change",async function(){const n=e(this).val(),i=e("#noteIdColumnSelect");if(!n){i.empty().append('<option value="">\u8BF7\u5148\u9009\u62E9\u8868\u683C</option>').prop("disabled",!0);return}try{const s=await L.base.getTableById(n),g=await s.getFieldList();i.empty().append('<option value="">\u8BF7\u9009\u62E9\u7B14\u8BB0ID\u5217</option>');for(const p of g){const l=await s.getFieldMetaById(p.id);if(l.type===1){const f=`<option value="${p.id}">${l.name}</option>`;i.append(f)}}i.prop("disabled",!1)}catch(s){console.error("\u52A0\u8F7D\u5B57\u6BB5\u5217\u8868\u5931\u8D25:",s),d("\u52A0\u8F7D\u5B57\u6BB5\u5217\u8868\u5931\u8D25","error")}}),e("#startProcessingBtn").on("click",async function(){try{if(o==="blogger")await h();else if(o==="single")await y();else if(o==="autoPush"){d("\u656C\u8BF7\u671F\u5F85\uFF1A\u81EA\u52A8\u63A8\u9001\u529F\u80FD\u6B63\u5728\u5F00\u53D1\u4E2D","info");return}}catch(n){console.error("Start processing error:",n),d("\u5904\u7406\u5931\u8D25: "+((n==null?void 0:n.message)||"\u672A\u77E5\u9519\u8BEF"),"error"),e("#startProcessingBtn").prop("disabled",!1),e("#startProcessingBtn").css({opacity:"1",cursor:"pointer",background:"","pointer-events":"auto"}),e("#progressContainer").hide()}});async function h(){const n=e("#existingTableSelect").val();if(!n){d("\u8BF7\u5148\u9009\u62E9\u4E00\u4E2A\u8868\u683C","error");return}const i=e("#bloggerUrlInput").val();if(!i||i.trim()===""){d("\u8BF7\u8F93\u5165\u5C0F\u7EA2\u4E66\u535A\u4E3B\u94FE\u63A5\u6216ID","warning");return}const s=e("#fetchModeSelect").val();console.log("\u9009\u62E9\u7684\u83B7\u53D6\u6A21\u5F0F:",s);let g=ie();if(!g||g===""){d("\u8BF7\u5148\u9009\u62E9\u8981\u91C7\u96C6\u7684\u5B57\u6BB5","warning");return}const p=R();if(!p){d("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error");return}let l="";try{l=await ue(i)}catch{d("\u63D0\u53D6\u535A\u4E3BID\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u94FE\u63A5\u683C\u5F0F","error");return}r=!1,u=!1,e("#progressContainer").show(),e("#pauseStatus").hide(),e("#pauseBtn").text("\u6682\u505C").prop("disabled",!1),e("#startProcessingBtn").prop("disabled",!0),e("#startProcessingBtn").css({opacity:"0.5",cursor:"not-allowed",background:"#d9d9d9","pointer-events":"none"}),await _(n,l,g,p,s)}async function y(){const n=e("#singleTableSelect").val();if(!n){d("\u8BF7\u5148\u9009\u62E9\u4E00\u4E2A\u8868\u683C","error");return}const i=e("#noteIdColumnSelect").val();if(!i){d("\u8BF7\u5148\u9009\u62E9\u7B14\u8BB0ID\u5217","warning");return}let s=ie();if(!s||s===""){d("\u8BF7\u5148\u9009\u62E9\u8981\u91C7\u96C6\u7684\u5B57\u6BB5","warning");return}const g=R();if(!g){d("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error");return}try{const p=await L.base.getTableById(n),l=d("\u6B63\u5728\u6253\u5F00\u8BB0\u5F55\u9009\u62E9\u5668...","loading"),f=await L.base.getSelection();if(!f.viewId){d("\u65E0\u6CD5\u83B7\u53D6\u89C6\u56FEID\uFF0C\u8BF7\u91CD\u8BD5","error");return}const E=await L.ui.selectRecordIdList(n,f.viewId);if(l&&l.parentNode&&l.parentNode.removeChild(l),!E||E.length===0){d("\u672A\u9009\u62E9\u4EFB\u4F55\u8BB0\u5F55\uFF0C\u64CD\u4F5C\u5DF2\u53D6\u6D88","warning");return}console.log("\u7528\u6237\u9009\u62E9\u7684\u8BB0\u5F55:",E),r=!1,u=!1,e("#progressContainer").show(),e("#userCardTitle").hide(),e("#userCard").hide(),e("#pauseStatus").hide(),e("#pauseBtn").text("\u6682\u505C").prop("disabled",!1),e("#startProcessingBtn").prop("disabled",!0),e("#startProcessingBtn").css({opacity:"0.5",cursor:"not-allowed",background:"#d9d9d9","pointer-events":"none"}),await D(p,E,i,s,g)}catch(p){console.error("\u5904\u7406\u5931\u8D25:",p),d("\u5904\u7406\u5931\u8D25: "+(p instanceof Error?p.message:String(p)),"error"),e("#startProcessingBtn").prop("disabled",!1).css({opacity:"1",cursor:"pointer",background:"","pointer-events":"auto"})}}async function D(n,i,s,g,p){try{const l=i.length;let f=0,E=0,T=0;const k=await V(n,g.split(","));console.log("\u4F7F\u7528\u7B14\u8BB0ID\u5217:",s),console.log("\u5B57\u6BB5ID\u6620\u5C04:",k),console.log("\u5B57\u6BB5\u6620\u5C04\u8BE6\u60C5:",Array.from(k.entries()));const z=await L.bridge.getBaseUserId();for(const x of i){for(;r&&!u;)await new Promise(v=>setTimeout(v,100));if(u)break;try{const v=await n.getRecordById(x);console.log("\u83B7\u53D6\u8BB0\u5F55:",x,"\u8BB0\u5F55\u6570\u636E:",v);const w=v.fields[s];let m="";if(typeof w=="string")m=w;else if(w&&typeof w=="object")if(Array.isArray(w)&&w.length>0){const F=w[0];m=F.text||F.value||""}else m=w.text||w.value||"";if(!m||m.trim()===""){console.log("\u8BB0\u5F55",x,"\u7684\u7B14\u8BB0ID\u4E3A\u7A7A\uFF0C\u8DF3\u8FC7"),T++,f++,P(f,l,`\u6B63\u5728\u5904\u7406: ${f}/${l} (\u6210\u529F: ${E}, \u8DF3\u8FC7: ${T})`);continue}m=m.trim(),P(f,l,`\u6B63\u5728\u83B7\u53D6\u7B14\u8BB0: ${m} (${f+1}/${l})`);const I=localStorage.getItem("xhsCookie")||"",b=await(await fetch("https://shop.leshangyundian.com/feishu/user/xhs/note",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`},body:JSON.stringify({noteId:m})})).json();if(console.log("API\u8FD4\u56DE\u7ED3\u679C:",b),b.success&&b.data){const F=b.data;await G(n,x,F,k),E++}else console.error("\u83B7\u53D6\u7B14\u8BB0\u5931\u8D25:",m,b.msg),T++}catch(v){console.error("\u5904\u7406\u8BB0\u5F55\u5931\u8D25:",x,v),T++}if(f++,P(f,l,`\u6B63\u5728\u5904\u7406: ${f}/${l} (\u6210\u529F: ${E}, \u5931\u8D25: ${T})`),f<l){const v=Math.floor(Math.random()*200)+300;await new Promise(w=>setTimeout(w,v))}}P(l,l,`\u5904\u7406\u5B8C\u6210! \u603B\u6570: ${l}, \u6210\u529F: ${E}, \u5931\u8D25: ${T}`),d(`\u5904\u7406\u5B8C\u6210! \u6210\u529F: ${E}, \u5931\u8D25: ${T}`,"success");try{const x=await fetch("https://shop.leshangyundian.com/feishu/user/info",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`}});if(x.ok){const v=await x.json();v.success===!0&&v.data&&(Z(v.data),await J(v.data))}}catch(x){console.error("\u5237\u65B0\u7528\u6237\u4FE1\u606F\u5931\u8D25:",x)}e("#startProcessingBtn").prop("disabled",!1).css({opacity:"1",cursor:"pointer",background:"","pointer-events":"auto"}),setTimeout(()=>{e("#progressContainer").fadeOut(300)},3e3)}catch(l){console.error("Process single notes error:",l),d("\u5904\u7406\u5931\u8D25: "+((l==null?void 0:l.message)||"\u672A\u77E5\u9519\u8BEF"),"error"),e("#startProcessingBtn").prop("disabled",!1).css({opacity:"1",cursor:"pointer",background:"","pointer-events":"auto"}),e("#progressContainer").hide()}}e("#pauseBtn").on("click",function(){r||(r=!0,u=!0,e("#pauseBtn").text("\u5DF2\u6682\u505C").prop("disabled",!0),e("#pauseStatus").show(),console.log("\u7528\u6237\u70B9\u51FB\u6682\u505C"))}),e("#resumeBtn").on("click",async function(){r=!1,u=!1,e("#pauseStatus").hide(),e("#pauseBtn").text("\u6682\u505C").prop("disabled",!1),console.log("\u7528\u6237\u70B9\u51FB\u7EE7\u7EED")});function P(n,i,s){const g=i>0?Math.round(n/i*100):0;e("#progressBar").css("width",g+"%"),e("#progressText").text(s),e("#progressStats").text(`\u5DF2\u83B7\u53D6: ${n} \u6761`)}function U(n){if(!n){console.log("\u6CA1\u6709userData\uFF0C\u4E0D\u663E\u793A\u7528\u6237\u5361\u7247");return}console.log("\u663E\u793A\u7528\u6237\u5361\u7247:",n);const i=n.basicInfo||{},s=n.detailedInfo||{},g=n.statistics||{},p=i.avatar||"";p?(e("#userAvatarImg").attr("src",p).show(),e("#userAvatarPlaceholder").hide()):(e("#userAvatarImg").hide(),e("#userAvatarPlaceholder").show());const l=i.nickname||"\u672A\u77E5\u7528\u6237";e("#userName").text(l);const f=i.redId||"";f?e("#userRedId").text("\u5C0F\u7EA2\u4E66\u53F7: "+f).show():e("#userRedId").hide();const E=s.description||i.desc||"\u6682\u65E0\u7B80\u4ECB";e("#userDesc").text(E);const T=parseInt(g.fansCount||i.fansCount||0);e("#userFans").text(O(T));const k=parseInt(g.postedNotes||0);e("#userNotes").text(O(k));const z=parseInt(g.likedCount||0),x=parseInt(g.collectedNotes||g.colle||0),v=parseInt(g.collectedCount||0),w=z+x+v;e("#userLikes").text(O(w)),e("#userCardTitle").fadeIn(300),e("#userCard").fadeIn(300)}function O(n){return n>=1e4?(n/1e4).toFixed(1)+"\u4E07":n.toLocaleString()}async function _(n,i,s,g,p="all"){try{console.log("\u5F00\u59CB\u83B7\u53D6\u535A\u4E3B\u7B14\u8BB0, xhsId:",i,"\u6A21\u5F0F:",p);const l=await L.base.getTableById(n);console.log("\u51C6\u5907\u83B7\u53D6\u6216\u521B\u5EFA\u5B57\u6BB5, selectedFields:",s);const f=await V(l,s.split(","));await new Promise(B=>setTimeout(B,2e3)),console.log("\u91CD\u65B0\u83B7\u53D6\u5B57\u6BB5\u5217\u8868...");const E=await l.getFieldMetaList(),T=new Map;E.forEach(B=>{T.set(B.name,B.id)});const k=new Map;for(const B of s.split(",")){const b=K.find(F=>F.key===B);!b||T.has(b.label)&&(k.set(B,T.get(b.label)),console.log(`\u5B57\u6BB5\u6620\u5C04: ${B} -> ${b.label} -> ${T.get(b.label)}`))}console.log("\u5B57\u6BB5\u6620\u5C04\u521B\u5EFA\u5B8C\u6210:",k);const z=k.get("noteId");let x="";if(p==="append"&&z){console.log("\u8FFD\u52A0\u6A21\u5F0F\uFF1A\u5C1D\u8BD5\u83B7\u53D6\u6700\u65B0\u7B14\u8BB0ID\u4F5C\u4E3Acursor");try{const B=await l.getRecords({pageSize:1});if(B&&B.records&&B.records.length>0){const F=B.records[0].fields[z];if(typeof F=="string")x=F;else if(F&&typeof F=="object")if(Array.isArray(F)&&F.length>0){const M=F[0];x=M.text||M.value||""}else{const M=F;x=M.text||M.value||""}console.log("\u83B7\u53D6\u5230\u6700\u540E\u4E00\u884C\u7684\u7B14\u8BB0ID\u4F5C\u4E3Acursor:",x)}}catch(B){console.log("\u83B7\u53D6\u6700\u540E\u4E00\u884C\u7B14\u8BB0ID\u5931\u8D25\uFF0C\u5C06\u4E0D\u4F7F\u7528cursor:",B),x=""}}else p==="all"&&console.log("\u83B7\u53D6\u6240\u6709\u6A21\u5F0F\uFF1A\u4E0D\u4F7F\u7528\u521D\u59CBcursor");let v=0,w=0,m=0,I=!0;for(;I&&!u;){for(m++,console.log(`\u5F00\u59CB\u83B7\u53D6\u7B2C ${m} \u9875\u6570\u636E, cursor:`,x||"\u65E0");r&&!u;)console.log("\u5DF2\u6682\u505C\uFF0C\u7B49\u5F85\u7528\u6237\u7EE7\u7EED..."),await new Promise(A=>setTimeout(A,500));if(u){console.log("\u7528\u6237\u505C\u6B62\u83B7\u53D6");break}const B={xhsId:i};x&&(B.cursor=x,console.log("\u4F7F\u7528cursor:",x));const b=await fetch("https://shop.leshangyundian.com/feishu/user/xhs/notes",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify(B)});if(!b.ok)throw new Error(`HTTP ${b.status}: ${b.statusText}`);const F=await b.json();if(!F.success||!F.data)throw new Error(F.msg||"\u83B7\u53D6\u7B14\u8BB0\u5217\u8868\u5931\u8D25");const M=F.data,S=M.notes||[],C=M.userData||{};if(I=M.hasMore===!0,console.log(`\u7B2C ${m} \u9875: \u83B7\u53D6\u5230 ${S.length} \u6761\u7B14\u8BB0, hasMore:`,I),m===1&&C&&Object.keys(C).length>0&&U(C),S.length===0){console.log("\u672C\u9875\u65E0\u7B14\u8BB0\uFF0C\u7ED3\u675F\u83B7\u53D6");break}P(v,0,`\u6B63\u5728\u5904\u7406\u7B2C ${m} \u9875...`);for(let A=0;A<S.length;A++){if(u){console.log("\u7528\u6237\u505C\u6B62\u83B7\u53D6\uFF0C\u5904\u7406\u5B8C\u5F53\u524D\u9875");break}try{const H=S[A],$=await l.addRecord({fields:{}});await G(l,$,H,k,C),v++,P(v,0,`\u6B63\u5728\u5904\u7406\u7B2C ${m} \u9875\uFF0C\u7B2C ${A+1}/${S.length} \u6761\u7B14\u8BB0...`),A<S.length-1&&await new Promise(W=>setTimeout(W,500))}catch(H){w++,console.error("\u6DFB\u52A0\u7B14\u8BB0\u5931\u8D25:",H)}}if(u){console.log("\u7528\u6237\u505C\u6B62\u83B7\u53D6");break}I&&(x=S[S.length-1].id,console.log("\u51C6\u5907\u83B7\u53D6\u4E0B\u4E00\u9875\uFF0C\u4F7F\u7528cursor:",x),await new Promise(H=>setTimeout(H,1e3)))}e("#progressBar").css("width","100%"),e("#progressText").text("\u5B8C\u6210\uFF01"),e("#pauseBtn").prop("disabled",!0),d(`\u5904\u7406\u5B8C\u6210\uFF01\u6210\u529F\u6DFB\u52A0: ${v}, \u5931\u8D25: ${w}`,"success"),e("#startProcessingBtn").prop("disabled",!1),e("#startProcessingBtn").css({opacity:"1",cursor:"pointer",background:"","pointer-events":"auto"}),setTimeout(()=>{e("#progressContainer").hide(),e("#pauseBtn").text("\u6682\u505C").prop("disabled",!1),e("#progressBar").css("width","0%")},3e3)}catch(l){console.error("\u83B7\u53D6\u535A\u4E3B\u7B14\u8BB0\u5931\u8D25:",l),d("\u83B7\u53D6\u7B14\u8BB0\u5931\u8D25: "+((l==null?void 0:l.message)||"\u672A\u77E5\u9519\u8BEF"),"error"),e("#startProcessingBtn").prop("disabled",!1),e("#startProcessingBtn").css({opacity:"1",cursor:"pointer",background:"","pointer-events":"auto"}),e("#progressContainer").hide()}}async function V(n,i){console.log("========== \u5F00\u59CB\u83B7\u53D6\u6216\u521B\u5EFA\u5B57\u6BB5 =========="),console.log("selectedFieldKeys:",i),console.log("AVAILABLE_FIELDS:",K);const s=new Map,g=await n.getFieldMetaList();console.log("fieldMetaList:",g);const p=new Map;g.forEach(l=>{p.set(l.name,l.id)}),console.log("existingFields:",Array.from(p.entries()));for(const l of i){console.log("\u5904\u7406\u5B57\u6BB5key:",l);const f=K.find(T=>T.key===l);if(console.log("\u627E\u5230\u5B57\u6BB5\u5B9A\u4E49:",f),!f)continue;let E;if(p.has(f.label))E=p.get(f.label),console.log(`\u5B57\u6BB5\u5DF2\u5B58\u5728: ${f.label} -> ${E}`);else try{console.log(`\u51C6\u5907\u521B\u5EFA\u5B57\u6BB5: ${f.label}, \u7C7B\u578B: ${f.type}`),E=(await te(n,f.label,f.type)).id,console.log(`\u521B\u5EFA\u5B57\u6BB5\u6210\u529F: ${f.label} (\u7C7B\u578B: ${f.type}) -> ${E}`)}catch(T){console.error(`\u521B\u5EFA\u5B57\u6BB5\u5931\u8D25: ${f.label}`,T);continue}s.set(l,E)}return console.log("\u6700\u7EC8\u5B57\u6BB5\u6620\u5C04:",Array.from(s.entries())),console.log("===================================="),s}async function te(n,i,s){switch(s){case 1:return await n.addField({type:1,name:i,property:{}});case 2:return await n.addField({type:2,name:i,property:{}});case 3:return await n.addField({type:3,name:i,property:{options:[{name:"\u56FE\u6587\u7B14\u8BB0"},{name:"\u89C6\u9891\u7B14\u8BB0"}]}});case 4:return await n.addField({type:4,name:i,property:{options:[]}});case 15:return await n.addField({type:15,name:i,property:{}});case 17:return await n.addField({type:17,name:i,property:{}});default:throw new Error(`\u4E0D\u652F\u6301\u7684\u5B57\u6BB5\u7C7B\u578B: ${s}`)}}async function G(n,i,s,g,p){var l,f,E,T,k,z,x;try{console.log("========== \u5F00\u59CB\u5199\u5165\u6570\u636E =========="),console.log("recordId:",i),console.log("noteData\u7C7B\u578B:",typeof s),console.log("noteData:",s),console.log("userData:",p),console.log("fieldIdMap:",g),console.log("fieldIdMap entries:",Array.from(g.entries())),console.log("====================================");const v={},w={singleSelect:new Map,multiSelect:new Map,attachment:new Map,dateTime:new Map};for(const[m,I]of g.entries()){const B=K.find(F=>F.key===m);if(!B)continue;let b=null;switch(m){case"noteId":b=s.id||"";break;case"authorNickname":b=((l=s.user)==null?void 0:l.nickname)||"";break;case"authorRedId":b=((f=s.user)==null?void 0:f.redId)||((E=p==null?void 0:p.basicInfo)==null?void 0:E.redId)||"",console.log("\u5C0F\u7EA2\u4E66\u53F7\u83B7\u53D6\u7ED3\u679C:",{"noteData.user.redId":(T=s.user)==null?void 0:T.redId,"userData.basicInfo.redId":(k=p==null?void 0:p.basicInfo)==null?void 0:k.redId,\u6700\u7EC8\u503C:b});break;case"bloggerHomepage":b=((z=p==null?void 0:p.detailedInfo)==null?void 0:z.shareLink)||"",console.log("\u535A\u4E3B\u4E3B\u9875\u83B7\u53D6\u7ED3\u679C:",{"userData.detailedInfo.shareLink":(x=p==null?void 0:p.detailedInfo)==null?void 0:x.shareLink,\u6700\u7EC8\u503C:b});break;case"sticky":const F=s.sticky===!0?"\u7F6E\u9876\u7B14\u8BB0":"\u666E\u901A\u7B14\u8BB0";w.singleSelect.set(I,F);continue;case"type":const M=String(s.type==="video"?"\u89C6\u9891\u7B14\u8BB0":"\u56FE\u6587\u7B14\u8BB0");w.singleSelect.set(I,M);continue;case"title":b=s.title||s.displayTitle||"";break;case"description":let S=s.desc||"";S=S.replace(/#[^\[#\]]+(?:\[话题\])?#/g,"").trim(),S=S.replace(/\s+/g," ").trim(),b=S;break;case"imageAttachments":let C=[];if(s.imageList&&Array.isArray(s.imageList)?C=s.imageList.map($=>String($.imageUrl||$||"")).filter($=>$):s.imagesList&&Array.isArray(s.imagesList)?C=s.imagesList.map($=>String($.imageUrl||$||"")).filter($=>$):typeof s.cover=="string"&&(C=[s.cover]),console.log("\u56FE\u7247\u5B57\u6BB5\u6570\u636E:",{hasImageList:!!s.imageList,hasImagesList:!!s.imagesList,hasCover:!!s.cover,imageUrlsCount:C.length,imageUrls:C}),C.length>0){const $=await se(C);console.log(`\u4E0B\u8F7D\u5B8C\u6210\uFF0C\u83B7\u53D6\u5230 ${$.length} \u4E2A\u6587\u4EF6`),$.length>0&&w.attachment.set(I,$)}else console.log("\u6CA1\u6709\u627E\u5230\u56FE\u7247URL");continue;case"tags":let A=[];if(s.tags&&Array.isArray(s.tags)&&s.tags.length>0)A=s.tags;else{const W=(s.desc||"").match(/#([^\[#\]]+)(?:\[话题\])?#/g);W&&W.length>0&&(A=W.map(ae=>ae.replace(/^#/,"").replace(/#$/,"").replace(/\[话题\]/g,"").trim()).filter(ae=>ae))}A.length>0&&(w.multiSelect.set(I,A),console.log("\u63D0\u53D6\u5230\u7684\u8BDD\u9898:",A));continue;case"likes":b=s.likedCount||0;break;case"collects":b=s.collectedCount||0;break;case"shares":b=s.shareCount||s.sharedCount||0;break;case"comments":b=s.commentsCount||0;break;case"videoUrl":b=s.videoUrl||"";break;case"videoDuration":b=s.duration||0;break;case"videoSubtitle":s.subtitleUrl&&(b=await oe(s.subtitleUrl));break;case"videoText":s.subtitleUrl&&(b=await ne(s.subtitleUrl));break;case"publishTime":b=s.createTimeStr||s.createTime||"";break;case"fetchTime":b=new Date().toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\//g,"-");break;case"source":p?b="\u535A\u4E3B\u4E3B\u9875\u83B7\u53D6":b="\u5B8C\u6574\u6570\u636E\u83B7\u53D6";break}if(b!=null)switch(B.type){case 1:v[I]=String(b||"");break;case 2:v[I]=Number(b)||0;break;case 15:v[I]=String(b||"");break}}Object.keys(v).length>0&&(await n.setRecord(i,{fields:v}),console.log("\u666E\u901A\u5B57\u6BB5\u66F4\u65B0\u6210\u529F:",v));for(const[m,I]of w.singleSelect.entries())try{console.log(`\u5904\u7406\u5355\u9009\u5B57\u6BB5: ${m}, \u503C: ${I}`);const B=await n.getField(m),b=await B.getOptions(),F=String(I||"");let M=null;const S=b.find(C=>C.name===F);if(S)M=S.id;else{await B.addOptions([{name:F}]);const A=(await B.getOptions()).find(H=>H.name===F);A&&(M=A.id)}M&&(await B.setValue(i,M),console.log(`\u5355\u9009\u5B57\u6BB5\u8BBE\u7F6E\u6210\u529F: ${m} = ${F}`))}catch(B){console.error(`\u8BBE\u7F6E\u5355\u9009\u5B57\u6BB5\u5931\u8D25: ${m}`,B)}for(const[m,I]of w.multiSelect.entries())try{console.log(`\u5904\u7406\u591A\u9009\u5B57\u6BB5: ${m}, \u503C:`,I);const B=await n.getField(m),b=await B.getOptions(),F=I.map(C=>String(C||"")).filter(C=>C);if(F.length===0){console.log(`\u591A\u9009\u5B57\u6BB5\u65E0\u6709\u6548\u9009\u9879\uFF0C\u8DF3\u8FC7: ${m}`);continue}const M=b.map(C=>C.name),S=F.filter(C=>!M.includes(C));if(S.length>0){const C=S.map($=>({name:$}));await B.addOptions(C);const H=(await B.getOptions()).filter($=>F.includes($.name)).map($=>$.id);await B.setValue(i,H),console.log(`\u591A\u9009\u5B57\u6BB5\u8BBE\u7F6E\u6210\u529F: ${m} = ${F.join(", ")}`)}else if(F.length>0){const C=b.filter(A=>F.includes(A.name)).map(A=>A.id);await B.setValue(i,C),console.log(`\u591A\u9009\u5B57\u6BB5\u8BBE\u7F6E\u6210\u529F: ${m} = ${F.join(", ")}`)}else await B.setValue(i,[]),console.log(`\u591A\u9009\u5B57\u6BB5\u5DF2\u6E05\u7A7A: ${m}`)}catch(B){console.error(`\u8BBE\u7F6E\u591A\u9009\u5B57\u6BB5\u5931\u8D25: ${m}`,B)}for(const[m,I]of w.attachment.entries())try{console.log(`\u5904\u7406\u9644\u4EF6\u5B57\u6BB5: ${m}, \u6587\u4EF6\u6570: ${I.length}`),await(await n.getField(m)).setValue(i,I),console.log(`\u9644\u4EF6\u5B57\u6BB5\u8BBE\u7F6E\u6210\u529F: ${m}, \u6587\u4EF6\u6570: ${I.length}`)}catch(B){console.error(`\u8BBE\u7F6E\u9644\u4EF6\u5B57\u6BB5\u5931\u8D25: ${m}`,B)}for(const[m,I]of w.dateTime.entries())try{console.log(`\u5904\u7406\u65E5\u671F\u65F6\u95F4\u5B57\u6BB5: ${m}, \u65F6\u95F4\u6233: ${I}`);const B=await n.getField(m);await B.setDateFormat(be.DATE_TIME),await B.setValue(i,I),console.log(`\u65E5\u671F\u65F6\u95F4\u5B57\u6BB5\u8BBE\u7F6E\u6210\u529F: ${m} = ${new Date(I).toLocaleString()}`)}catch(B){console.error(`\u8BBE\u7F6E\u65E5\u671F\u65F6\u95F4\u5B57\u6BB5\u5931\u8D25: ${m}`,B)}}catch(v){throw console.error("\u5199\u5165\u6570\u636E\u5230\u8BB0\u5F55\u5931\u8D25:",v),v}}async function oe(n){try{const i=await fetch(n);return i.ok?await i.text():""}catch(i){return console.error("\u83B7\u53D6\u539F\u59CB\u5B57\u5E55\u5931\u8D25:",i),""}}async function ne(n){try{const i=await fetch(n);if(!i.ok)return"";const g=(await i.text()).split(`
`),p=[];for(const l of g){const f=l.trim();!f||/^\d{2}:\d{2}:\d{2},\d{3}\s*-->\s*\d{2}:\d{2}:\d{2},\d{3}$/.test(f)||/^\d+$/.test(f)||p.push(f)}return p.join(`
`)}catch(i){return console.error("\u83B7\u53D6\u5B57\u5E55\u5931\u8D25:",i),""}}async function se(n,i){const s=[];for(let g=0;g<n.length;g++){const p=n[g];try{i&&i(g+1,n.length,`\u4E0B\u8F7D\u56FE\u7247 ${g+1}/${n.length}`);const l=await fe(p);s.push(...l),g<n.length-1&&await new Promise(f=>setTimeout(f,200))}catch(l){console.error(`\u4E0B\u8F7D\u56FE\u7247\u5931\u8D25: ${p}`,l)}}return s}async function fe(n){try{let i=n;n.startsWith("http://")&&(i=n.replace("http://","https://")),console.log(`\u5F00\u59CB\u4E0B\u8F7D\u56FE\u7247: ${i}`);const s=await fetch(i,{method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}});if(!s.ok)return console.error(`\u4E0B\u8F7D\u5931\u8D25\uFF0CHTTP\u72B6\u6001\u7801: ${s.status}, URL: ${i}`),[];const g=await s.blob();console.log(`\u56FE\u7247\u4E0B\u8F7D\u6210\u529F\uFF0C\u5927\u5C0F: ${g.size} bytes, \u7C7B\u578B: ${g.type}`);const p=g.type.split("/")[1]||"jpg",l=`image_${Date.now()}.${p}`;return[new File([g],l,{type:g.type})]}catch(i){return console.error(`\u4E0B\u8F7D\u9644\u4EF6\u5931\u8D25: ${n}`,i),[]}}e("#existingTableSelect").on("change",async function(){await le()}),e("#selectAllFields").on("click",function(){e('#fieldSelectionContainer input[type="checkbox"]').prop("checked",!0)}),e("#deselectAllFields").on("click",function(){e('#fieldSelectionContainer input[type="checkbox"]').prop("checked",!1)}),e("#languageToggle").on("click",function(){const i=c.language==="zh"?"en":"zh";c.changeLanguage(i,(s,g)=>{if(s)return console.error("Failed to change language:",s);re(),e("#currentLanguage").text(i==="zh"?"\u4E2D\u6587":"English"),localStorage.setItem("preferred_language",i),q()})});const Q=localStorage.getItem("preferred_language");Q&&["zh","en"].includes(Q)&&c.changeLanguage(Q,(n,i)=>{if(n)return console.error("Failed to restore language:",n);re(),e("#currentLanguage").text(Q==="zh"?"\u4E2D\u6587":"English")})});
